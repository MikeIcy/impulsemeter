<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–µ—Ç–µ–∫—Ç–æ—Ä –Ü–º–ø—É–ª—å—Å—ñ–≤ –õ—ñ—á–∏–ª—å–Ω–∏–∫–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        #videoElement {
            width: 100%;
            max-width: 400px;
            transform: scaleX(-1); /* –î–∑–µ—Ä–∫–∞–ª—å–Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ */
            display: block;
            margin: 0 auto;
            border: 2px solid #333;
        }
        #canvasElement {
            display: none; /* –ü—Ä–∏—Ö–æ–≤—É—î–º–æ canvas, –≤—ñ–Ω –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –ª–∏—à–µ –¥–ª—è –æ–±—Ä–æ–±–∫–∏ */
        }
        #roiOverlay {
            position: absolute;
            width: 50px; /* –ó–æ–Ω–∞ —ñ–Ω—Ç–µ—Ä–µ—Å—É */
            height: 50px;
            border: 2px solid red;
            background-color: rgba(255, 0, 0, 0.2);
            /* –ü–æ–∑–∏—Ü—ñ–æ–Ω—É–≤–∞–Ω–Ω—è —Ü–µ–Ω—Ç—Ä—É (–ø–æ—Ç—Ä—ñ–±–Ω–æ –±—É–¥–µ —É—Ç–æ—á–Ω–∏—Ç–∏ –≤ JS) */
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none; /* –©–æ–± –Ω–µ –±–ª–æ–∫—É–≤–∞—Ç–∏ –≤–∑–∞—î–º–æ–¥—ñ—é */
        }
        #results, #settings {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            text-align: left;
        }
        #settings input {
            width: 100px;
            padding: 5px;
            margin-left: 10px;
        }
        button {
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <h2>‚ö° –î–µ—Ç–µ–∫—Ç–æ—Ä –Ü–º–ø—É–ª—å—Å—ñ–≤ (–ë—Ä–∞—É–∑–µ—Ä)</h2>
    <p>–ù–∞–≤–µ–¥—ñ—Ç—å —á–µ—Ä–≤–æ–Ω—É —Ä–∞–º–∫—É –Ω–∞ —Å–≤—ñ—Ç–ª–æ–¥—ñ–æ–¥ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞.</p>

    <div style="position: relative; display: inline-block;">
        <video id="videoElement" autoplay playsinline></video>
        <div id="roiOverlay"></div>
    </div>
    
    <canvas id="canvasElement"></canvas>

    <div id="settings">
        <h3>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h3>
        <label for="meterConstant">
            –ü–æ—Å—Ç—ñ–π–Ω–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ (—ñ–º–ø./–∫–í—Ç‚ãÖ–≥–æ–¥):
            <input type="number" id="meterConstant" value="1000" min="1" step="1">
        </label>
        <p style="font-size: small; color: #666;">(–ó–∞–∑–≤–∏—á–∞–π 1000, 1600, 3200 –∞–±–æ 6400)</p>
        <button id="resetButton">üîÑ –°–∫–∏–Ω—É—Ç–∏ –õ—ñ—á–∏–ª—å–Ω–∏–∫</button>
    </div>
    
    <div id="results">
        <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏</h3>
        <p><strong>–Ø—Å–∫—Ä–∞–≤—ñ—Å—Ç—å (Debug):</strong> <span id="currentBrightness">0</span></p>
        <p><strong>–ö—ñ–ª—å–∫—ñ—Å—Ç—å —ñ–º–ø—É–ª—å—Å—ñ–≤:</strong> <span id="pulseCount">0</span></p>
        <p><strong>–ß–∞—Å –º—ñ–∂ —ñ–º–ø—É–ª—å—Å–∞–º–∏ (–º—Å):</strong> <span id="pulseTime">--</span></p>
        <p><strong>–í–∏–º—ñ—Ä—é–≤–∞–Ω–∞ –ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å (–∫–í—Ç):</strong> <span id="currentPower">--</span></p>
    </div>

    <script>
        // --- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ---
        const THRESHOLD = 100; // –ü–æ—Ä—ñ–≥ —è—Å–∫—Ä–∞–≤–æ—Å—Ç—ñ –¥–ª—è –≤–∏—è–≤–ª–µ–Ω–Ω—è —ñ–º–ø—É–ª—å—Å—É (0-255). –†–µ–≥—É–ª—é–π—Ç–µ!
        const DEBOUNCE_DELAY = 500; // –ó–∞—Ç—Ä–∏–º–∫–∞ (–º—Å) –ø—ñ—Å–ª—è –≤–∏—è–≤–ª–µ–Ω–Ω—è —ñ–º–ø—É–ª—å—Å—É, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–æ–¥–≤—ñ–π–Ω–æ–≥–æ —Å–ø—Ä–∞—Ü—å–æ–≤—É–≤–∞–Ω–Ω—è
        const ROI_SIZE = 50; // –†–æ–∑–º—ñ—Ä –∑–æ–Ω–∏ —ñ–Ω—Ç–µ—Ä–µ—Å—É (–ø—ñ–∫—Å–µ–ª—ñ –≤ —Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–∞–¥—Ä—É)

        // --- –ï–ª–µ–º–µ–Ω—Ç–∏ DOM ---
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvasElement');
        const ctx = canvas.getContext('2d');
        const brightnessDisplay = document.getElementById('currentBrightness');
        const countDisplay = document.getElementById('pulseCount');
        const timeDisplay = document.getElementById('pulseTime');
        const powerDisplay = document.getElementById('currentPower'); // –ù–æ–≤–∏–π –µ–ª–µ–º–µ–Ω—Ç
        const roiOverlay = document.getElementById('roiOverlay');
        const resetButton = document.getElementById('resetButton'); // –ù–æ–≤–∏–π –µ–ª–µ–º–µ–Ω—Ç
        const meterConstantInput = document.getElementById('meterConstant'); // –ù–æ–≤–∏–π –µ–ª–µ–º–µ–Ω—Ç
        
        // --- –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –ª–æ–≥—ñ–∫–∏ ---
        let pulseCount = 0;
        let isDebouncing = false;
        let lastPulseTime = 0;
        let audioContext = null; // –î–ª—è –∑–≤—É–∫–æ–≤–æ–≥–æ —Å–∏–≥–Ω–∞–ª—É

        // --- –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ—Ä–æ—Ç–∫–æ–≥–æ "–ø—ñ—Å–∫—É" ---
        function playBeep() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.type = 'sine'; // –¢–∏–ø —Ö–≤–∏–ª—ñ
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // –ß–∞—Å—Ç–æ—Ç–∞ A4
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime); // –ì—É—á–Ω—ñ—Å—Ç—å

            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.05); // –ö–æ—Ä–æ—Ç–∫–∞ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å
        }
        
        // --- –§—É–Ω–∫—Ü—ñ—è –°–∫–∏–¥–∞–Ω–Ω—è –†–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ ---
        function resetResults() {
            pulseCount = 0;
            lastPulseTime = 0;
            countDisplay.textContent = 0;
            timeDisplay.textContent = '--';
            powerDisplay.textContent = '--';
            alert('–õ—ñ—á–∏–ª—å–Ω–∏–∫ —Å–∫–∏–Ω—É—Ç–æ!');
        }
        
        // –ü—Ä–∏–≤'—è–∑–∫–∞ –∫–Ω–æ–ø–∫–∏ —Å–∫–∏–¥–∞–Ω–Ω—è
        resetButton.addEventListener('click', resetResults);


        // --- 1. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ö–∞–º–µ—Ä–∏ ---
        async function setupCamera() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: "environment", // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∑–∞–¥–Ω—é –∫–∞–º–µ—Ä—É
                            width: 640,
                            height: 480
                        } 
                    });
                    video.srcObject = stream;
                    video.play();
                    video.onloadedmetadata = () => {
                        // –†–æ–∑–º—ñ—Ä Canvas –ø–æ–≤–∏–Ω–µ–Ω –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ —Ä–æ–∑–º—ñ—Ä—É –≤—ñ–¥–µ–æ
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        // –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ü–∏–∫–ª –∞–Ω–∞–ª—ñ–∑—É –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–µ–æ
                        requestAnimationFrame(analyzeFrame);
                    };
                } catch (err) {
                    alert('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏: ' + err);
                    console.error('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏:', err);
                }
            } else {
                alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î MediaDevices API.');
            }
        }

        // --- 2. –¶–∏–∫–ª –ê–Ω–∞–ª—ñ–∑—É –ö–∞–¥—Ä—ñ–≤ (–ë–µ–∑ –∑–º—ñ–Ω) ---
        function analyzeFrame() {
            if (video.paused || video.ended) return;

            // 1. –ö–æ–ø—ñ—é—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π –∫–∞–¥—Ä –Ω–∞ canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // 2. –í–∏–∑–Ω–∞—á–∞—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ ROI (—Ü–µ–Ω—Ç—Ä –∫–∞–¥—Ä—É)
            const roiX = (canvas.width / 2) - (ROI_SIZE / 2);
            const roiY = (canvas.height / 2) - (ROI_SIZE / 2);

            // –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é —á–µ—Ä–≤–æ–Ω–æ—ó —Ä–∞–º–∫–∏ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            roiOverlay.style.left = `${(roiX / video.videoWidth) * 100}%`;
            roiOverlay.style.top = `${(roiY / video.videoHeight) * 100}%`;

            // 3. –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –ø—ñ–∫—Å–µ–ª—ñ–≤ –≤ ROI
            const imageData = ctx.getImageData(roiX, roiY, ROI_SIZE, ROI_SIZE);
            const data = imageData.data;

            // 4. –û–±—á–∏—Å–ª—é—î–º–æ —Å–µ—Ä–µ–¥–Ω—é —è—Å–∫—Ä–∞–≤—ñ—Å—Ç—å (Grayscale)
            let totalBrightness = 0;
            const numPixels = ROI_SIZE * ROI_SIZE;
            
            for (let i = 0; i < data.length; i += 4) {
                // R, G, B –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                // –§–æ—Ä–º—É–ª–∞ –¥–ª—è –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–∞ Grayscale (—è—Å–∫—Ä–∞–≤—ñ—Å—Ç—å)
                const brightness = (0.299 * r + 0.587 * g + 0.114 * b);
                totalBrightness += brightness;
            }

            const averageBrightness = totalBrightness / numPixels;
            brightnessDisplay.textContent = averageBrightness.toFixed(2);

            // 5. –õ–æ–≥—ñ–∫–∞ –≤–∏—è–≤–ª–µ–Ω–Ω—è —ñ–º–ø—É–ª—å—Å—É
            detectPulse(averageBrightness);

            // –ü–æ–≤—Ç–æ—Ä—é—î–º–æ –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –∫–∞–¥—Ä—ñ
            requestAnimationFrame(analyzeFrame);
        }

        // --- 3. –§—É–Ω–∫—Ü—ñ—è –î–µ—Ç–µ–∫—Ç—É–≤–∞–Ω–Ω—è –Ü–º–ø—É–ª—å—Å—É (–û–Ω–æ–≤–ª–µ–Ω–∞) ---
        function detectPulse(currentBrightness) {
            // –Ø–∫—â–æ —è—Å–∫—Ä–∞–≤—ñ—Å—Ç—å –ø–µ—Ä–µ–≤–∏—â—É—î –ø–æ—Ä—ñ–≥ –Ü –º–∏ –Ω–µ –≤ —Å—Ç–∞–Ω—ñ –∑–∞—Ç—Ä–∏–º–∫–∏:
            if (currentBrightness > THRESHOLD && !isDebouncing) {
                
                // --- –ó–Ω–∞–π–¥–µ–Ω–æ —ñ–º–ø—É–ª—å—Å! ---
                pulseCount++;
                countDisplay.textContent = pulseCount;

                playBeep(); // –í—ñ–¥—Ç–≤–æ—Ä—é—î–º–æ –∑–≤—É–∫–æ–≤–∏–π —Å–∏–≥–Ω–∞–ª

                const currentTime = Date.now();
                
                if (lastPulseTime !== 0) {
                    const timeDiff = currentTime - lastPulseTime;
                    timeDisplay.textContent = timeDiff;

                    // --- –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ü–æ—Ç—É–∂–Ω–æ—Å—Ç—ñ (–∫–í—Ç) ---
                    // –ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å (–∫–í—Ç) = (3 600 000 –º—Å/–≥–æ–¥) / (–ß–∞—Å –º—ñ–∂ —ñ–º–ø—É–ª—å—Å–∞–º–∏ –≤ –º—Å * –ü–æ—Å—Ç—ñ–π–Ω–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ —ñ–º–ø./–∫–í—Ç‚ãÖ–≥–æ–¥)
                    
                    const meterConstant = parseFloat(meterConstantInput.value);
                    
                    if (!isNaN(meterConstant) && meterConstant > 0) {
                        const powerKW = 3600000 / (timeDiff * meterConstant);
                        powerDisplay.textContent = powerKW.toFixed(3); // –ü–æ–∫–∞–∑—É—î–º–æ –∑ —Ç—Ä—å–æ–º–∞ –∑–Ω–∞–∫–∞–º–∏ –ø—ñ—Å–ª—è –∫–æ–º–∏
                    } else {
                        powerDisplay.textContent = "–ü–æ–º–∏–ª–∫–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏";
                    }
                }
                
                lastPulseTime = currentTime;

                // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –ø–æ–¥–≤—ñ–π–Ω–æ–º—É —Å–ø—Ä–∞—Ü—å–æ–≤—É–≤–∞–Ω–Ω—é (–î–µ–±–æ—É–Ω—Å–∏–Ω–≥)
                isDebouncing = true;
                
                // –¢–∏–º—á–∞—Å–æ–≤–æ –∑–º—ñ–Ω—é—î–º–æ –∫–æ–ª—ñ—Ä —Ä–∞–º–∫–∏ –¥–ª—è –≤—ñ–∑—É–∞–ª—å–Ω–æ–≥–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
                roiOverlay.style.borderColor = 'green';
                roiOverlay.style.backgroundColor = 'rgba(0, 255, 0, 0.4)';

                setTimeout(() => {
                    isDebouncing = false;
                    roiOverlay.style.borderColor = 'red';
                    roiOverlay.style.backgroundColor = 'rgba(255, 0, 0, 0.2)';
                }, DEBOUNCE_DELAY);
            }
        }

        // –ó–∞–ø—É—Å–∫–∞—î–º–æ –¥–æ–¥–∞—Ç–æ–∫
        setupCamera();

    </script>

</body>
</html>
